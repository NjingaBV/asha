name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

# Cancel in-progress runs for pull requests when new commits are pushed
concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

# Default permissions for GITHUB_TOKEN
permissions:
    contents: read

jobs:
    commitlint:
        if: ${{ github.event_name == 'pull_request' }}
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: read
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - uses: wagoid/commitlint-github-action@v5
              with:
                  configFile: commitlint.config.cjs

    lint:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              with:
                  version: 10.20.0

            - uses: actions/setup-node@v6
              with:
                  node-version: 'lts/*'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run linters
              run: pnpm run lint

    typecheck:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              with:
                  version: 10.20.0

            - uses: actions/setup-node@v6
              with:
                  node-version: 'lts/*'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run type check
              run: pnpm run check

    test:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              with:
                  version: 10.20.0

            - uses: actions/setup-node@v6
              with:
                  node-version: 'lts/*'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Install Playwright browsers
              run: pnpm exec playwright install --with-deps chromium

            - name: Run unit tests
              run: pnpm run test:unit -- --run

    build-package:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        env:
            NODE_OPTIONS: --max-old-space-size=4096
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              with:
                  version: 10.20.0

            - uses: actions/setup-node@v6
              with:
                  node-version: 'lts/*'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build package
              run: pnpm run build

            - name: Upload package artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: package-dist
                  path: dist/
                  retention-days: 7

    build-storybook:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        env:
            NODE_OPTIONS: --max-old-space-size=4096
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              with:
                  version: 10.20.0

            - uses: actions/setup-node@v6
              with:
                  node-version: 'lts/*'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build Storybook
              run: pnpm run build-storybook

            - name: Upload Storybook artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: storybook-static
                  path: storybook-static/
                  retention-days: 7
